<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PC Monitor & Chat Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }

        .computers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .computer-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: all 0.3s;
            position: relative;
        }

        .computer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        }

        .computer-card.online {
            border-left: 5px solid #4CAF50;
        }

        .computer-card.offline {
            border-left: 5px solid #f44336;
            opacity: 0.7;
        }

        .computer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .computer-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            color: white;
        }

        .status-online {
            background: #4CAF50;
        }

        .status-offline {
            background: #f44336;
        }

        .computer-info {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        .metrics {
            margin: 15px 0;
        }

        .metric-bar {
            margin: 10px 0;
        }

        .metric-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #666;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s, background-color 0.5s;
        }

        .progress-fill.normal {
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, #FF9800, #FFC107);
        }

        .progress-fill.danger {
            background: linear-gradient(90deg, #f44336, #E91E63);
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            flex: 1;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            color: white;
        }

        .btn-chat {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        .btn-chat:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-details {
            background: linear-gradient(135deg, #f093fb, #f5576c);
        }

        .btn-details:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #f44336;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        /* Chat Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            width: 90%;
            max-width: 600px;
            border-radius: 15px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .close:hover {
            transform: scale(1.2);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
            max-height: 400px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.agent {
            background: #e3f2fd;
            margin-right: auto;
        }

        .message.admin {
            background: #667eea;
            color: white;
            margin-left: auto;
        }

        .message-sender {
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .message-time {
            font-size: 0.7em;
            opacity: 0.7;
            margin-top: 5px;
        }

        .chat-input {
            display: flex;
            padding: 20px;
            background: white;
            border-radius: 0 0 15px 15px;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
        }

        .chat-input input:focus {
            border-color: #667eea;
        }

        .chat-input button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .chat-input button:hover {
            transform: scale(1.05);
        }

        .no-computers {
            text-align: center;
            padding: 50px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .no-computers h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 30px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñ•Ô∏è PC Monitor & Chat Dashboard</h1>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <div class="number" id="totalComputers">0</div>
            </div>
            <div class="stat-card">
                <h3>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Online</h3>
                <div class="number" style="color: #4CAF50;" id="onlineComputers">0</div>
            </div>
            <div class="stat-card">
                <h3>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á Offline</h3>
                <div class="number" style="color: #f44336;" id="offlineComputers">0</div>
            </div>
            <div class="stat-card">
                <h3>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà</h3>
                <div class="number" style="color: #FF9800;" id="unreadMessages">0</div>
            </div>
        </div>

        <div class="computers-grid" id="computersGrid">
            <!-- Computers will be loaded here -->
        </div>

        <div class="no-computers" id="noComputers" style="display: none;">
            <h2>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</h2>
            <p>‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å agents...</p>
        </div>
    </div>

    <button class="refresh-btn" onclick="loadComputers()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>

    <!-- Chat Modal -->
    <div id="chatModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="chatTitle">Chat</h2>
                <span class="close" onclick="closeChatModal()">&times;</span>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be loaded here -->
            </div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()">‡∏™‡πà‡∏á</button>
            </div>
        </div>
    </div>

    <script>
        let currentComputerId = null;
        let ws = null;

        // Connect to WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                console.log('WebSocket connected');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'metrics_update' || data.type === 'chat_message') {
                    loadComputers();
                    if (data.type === 'chat_message' && currentComputerId === data.computer_id) {
                        loadChatMessages(currentComputerId);
                    }
                }
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected. Reconnecting...');
                setTimeout(connectWebSocket, 3000);
            };
        }

        // Load computers data
        async function loadComputers() {
            try {
                const response = await fetch('/api/computers');
                const computers = await response.json();

                updateStats(computers);

                const grid = document.getElementById('computersGrid');
                const noComputers = document.getElementById('noComputers');

                if (computers.length === 0) {
                    grid.style.display = 'none';
                    noComputers.style.display = 'block';
                    return;
                }

                grid.style.display = 'grid';
                noComputers.style.display = 'none';

                grid.innerHTML = computers.map(computer => {
                    const statusClass = computer.is_online ? 'online' : 'offline';
                    const statusBadge = computer.is_online ? 'status-online' : 'status-offline';
                    const statusText = computer.is_online ? 'Online' : 'Offline';

                    const metric = computer.latest_metric;
                    const cpuClass = getMetricClass(metric?.cpu_percent);
                    const ramClass = getMetricClass(metric?.ram_percent);
                    const diskClass = getMetricClass(metric?.disk_percent);

                    const unreadBadge = computer.unread_messages > 0
                        ? `<span class="badge">${computer.unread_messages} ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà</span>`
                        : '';

                    return `
                        <div class="computer-card ${statusClass}">
                            ${unreadBadge}
                            <div class="computer-header">
                                <div class="computer-name">${computer.hostname}</div>
                                <span class="status-badge ${statusBadge}">${statusText}</span>
                            </div>
                            <div class="computer-info">
                                <div>üåê ${computer.ip_address}</div>
                                <div>üíª ${computer.os_info}</div>
                                <div>‚è∞ Last seen: ${formatTime(computer.last_seen)}</div>
                            </div>
                            ${metric ? `
                            <div class="metrics">
                                <div class="metric-bar">
                                    <div class="metric-label">
                                        <span>CPU</span>
                                        <span>${metric.cpu_percent.toFixed(1)}%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill ${cpuClass}" style="width: ${metric.cpu_percent}%"></div>
                                    </div>
                                </div>
                                <div class="metric-bar">
                                    <div class="metric-label">
                                        <span>RAM</span>
                                        <span>${metric.ram_percent.toFixed(1)}%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill ${ramClass}" style="width: ${metric.ram_percent}%"></div>
                                    </div>
                                </div>
                                <div class="metric-bar">
                                    <div class="metric-label">
                                        <span>Disk</span>
                                        <span>${metric.disk_percent.toFixed(1)}%</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill ${diskClass}" style="width: ${metric.disk_percent}%"></div>
                                    </div>
                                </div>
                            </div>
                            ` : '<div class="metrics">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• metrics</div>'}
                            <div class="actions">
                                <button class="btn btn-chat" onclick="openChatModal(${computer.id}, '${computer.hostname}')">
                                    üí¨ Chat
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading computers:', error);
            }
        }

        function updateStats(computers) {
            const total = computers.length;
            const online = computers.filter(c => c.is_online).length;
            const offline = total - online;
            const unread = computers.reduce((sum, c) => sum + c.unread_messages, 0);

            document.getElementById('totalComputers').textContent = total;
            document.getElementById('onlineComputers').textContent = online;
            document.getElementById('offlineComputers').textContent = offline;
            document.getElementById('unreadMessages').textContent = unread;
        }

        function getMetricClass(value) {
            if (!value) return 'normal';
            if (value >= 90) return 'danger';
            if (value >= 70) return 'warning';
            return 'normal';
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('th-TH');
        }

        // Chat functions
        async function openChatModal(computerId, hostname) {
            currentComputerId = computerId;
            document.getElementById('chatTitle').textContent = `Chat ‡∏Å‡∏±‡∏ö ${hostname}`;
            document.getElementById('chatModal').style.display = 'block';
            await loadChatMessages(computerId);
        }

        function closeChatModal() {
            document.getElementById('chatModal').style.display = 'none';
            currentComputerId = null;
        }

        async function loadChatMessages(computerId) {
            try {
                const response = await fetch(`/api/chat/messages/${computerId}`);
                const messages = await response.json();

                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = messages.map(msg => `
                    <div class="message ${msg.sender}">
                        <div class="message-sender">${msg.sender === 'admin' ? 'Admin' : 'Agent'}</div>
                        <div>${msg.message}</div>
                        <div class="message-time">${formatTime(msg.timestamp)}</div>
                    </div>
                `).join('');

                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Mark messages as read
                messages.filter(m => m.sender === 'agent' && !m.is_read).forEach(msg => {
                    fetch(`/api/chat/read/${msg.id}`, { method: 'PUT' });
                });
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message || !currentComputerId) return;

            try {
                await fetch('/api/chat/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        computer_id: currentComputerId,
                        sender: 'admin',
                        message: message
                    })
                });

                input.value = '';
                await loadChatMessages(currentComputerId);
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Initialize
        connectWebSocket();
        loadComputers();
        setInterval(loadComputers, 30000); // Reload every 30 seconds
    </script>
</body>
</html>
